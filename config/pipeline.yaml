# MegaDetector Pipeline Configuration
# Main configuration file for the camera trap animal detection and classification pipeline

paths:
  videos_raw: "data/test_md_vids"
  videos_work: "data/videos_work"  # optional: for re-encoded videos
  md_json: "data/md_json"
  tracks_json: "data/tracking_json"  # ByteTrack outputs (consistent naming)
  candidates: "data/candidates"
  autolabels: "data/autolabels"
  crops: "data/crops"
  crops_manifest: "data/crops_manifest.csv"
  cvat_exports: "data/cvat_exports"
  datasets: "data/datasets/species_cls"
  reports: "data/reports"
  preview_out: "outputs/preview"    # visualization outputs

# MegaDetector settings
megadetector:
  weights: "models/detectors/md_v5a.0.0.pt"
  img_size: 960           # 960 or 1280
  md_export_threshold: 0.25   # threshold for exporting detections to tracker (was 0.20)
  md_view_threshold: 0.25     # for visual debugging only
  iou_threshold: 0.55     # IoU threshold for NMS (keep calibrated value)
  classes: [0, 1]         # 0=animal, 1=person (includes human class)
  max_detections: 5       # max detections per frame
  min_area_ratio: 0.005   # minimum bbox area as fraction of frame (calibrated)
  frame_stride: 2         # process every Nth frame (calibrated from 5)
  include_person: true    # enable person detection for human species
  include_vehicle: false  # exclude vehicles for now

# ByteTrack tracking settings (ultra-conservative for stationary animals)
tracking:
  method: bytetrack       # explicit tracking method
  # Threshold hierarchy: md_export_threshold <= det_thresh <= track_thresh
  track_thresh: 0.70      # HIGH threshold - very strict new tracks (was 0.50)
  det_thresh: 0.25        # LOW threshold - keep for recovery (unchanged)
  match_thresh: 0.35      # IoU threshold - very permissive association (was 0.45)
  track_buffer_s: 2.5     # seconds to keep lost tracks - long memory (was 1.5)
  min_track_len: 8        # minimum detections - filter spurious tracks (was 5)
  nms_iou: 0.85          # per-frame NMS - aggressive deduplication (was 0.75)
  use_kalman: false      # motion prediction (start simple)
  class_map:             # MegaDetector classes -> species mapping
    person: human
    animal: animal
  include_person: true   # track humans (included in 13 species classes)

# Frame sampling and crop extraction
sampling:
  strategy: "hybrid"      # "stride", "topk", or "hybrid"
  frame_stride: 5         # sample every N frames within track
  topk_per_track: 16      # or use top-K most confident frames
  max_per_video: 30       # cap total crops per video
  diversity:
    enabled: true
    iou_threshold: 0.9    # skip frames too similar to previous
    min_area_ratio: 0.1   # require minimum bbox size variation
  
  # Quality filters
  filters:
    min_confidence: 0.5   # minimum detection confidence
    min_area: 5000        # minimum crop area
    max_border_ratio: 0.8 # reject if >80% of bbox touches image border
    blur_threshold: 100   # Laplacian blur detection threshold

# Auto-labeling from filename (weak supervision)
autolabel:
  enabled: true
  
  # Dominance rules - track must dominate the video
  dominance:
    min_track_coverage: 0.8     # track covers â‰¥80% of detection frames
    max_secondary_coverage: 0.3  # no other track covers >30%
    require_single_track: true   # prefer videos with only one substantial track
  
  # Quality rules
  quality:
    min_confidence_mean: 0.6    # average confidence across track
    min_track_length: 8         # minimum frames in track
    min_area_median: 8000       # median bbox area threshold
    max_border_frames_ratio: 0.5 # max fraction of frames touching border
  
  # Species-specific exceptions (require manual review)
  exceptions:
    - "margay:ocelote"          # confusable pairs
    - "gray_brocket:deer"
  
# Quality control
  spot_check_ratio: 0.1         # randomly review 10% of auto-labels

# Classification pipeline settings
classification:
  species_map: "config/species_map.yaml"
  crop_padding: 0.05            # padding applied around bbox before cropping
  neighbors: 2                  # frames to include on each side of representative frame
  min_track_len: 6              # minimum track length to consider for crops
  max_crops_per_track: 5        # limit crops per track to avoid imbalance
  skip_classes: ["no_animal", "unknown_animal"]
  split_strategy: "by_video"    # dataset split granularity
  random_seed: 42               # reproducibility for splitting

# Dataset splitting strategy
split:
  strategy: "by_video"          # or "by_camera" to prevent data leakage
  train: 0.7
  validation: 0.15
  test: 0.15
  random_seed: 42

# Logging and reporting
logging:
  level: "INFO"                 # DEBUG, INFO, WARNING, ERROR
  save_reports: true
  save_intermediate: true       # keep intermediate JSON files
  progress_bars: true

# Hardware settings
hardware:
  device: "cuda"                # "cuda", "cpu", or "auto"
  batch_size: 32               # for batch processing
  num_workers: 4               # dataloader workers
